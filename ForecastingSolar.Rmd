---
title: "A Forecast of U.S. Solar Energy Generation"
author: "David Noonan"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
---

This is a timeseries analysis of U.S. solar Energy generation. The data is from the U.S. Energy Information Administration, consisting of monthly totals from 1973 to June 2017. Here we will fit an ARIMA model for solar electricity generation, and make a 12-month forecast of future energy production.

```{r, message=FALSE, warning=FALSE, include=FALSE}
#load packages
library(tidyverse) #Tidyverse + lubridate for data manipulation
library(lubridate) #package for handling time data
library(tm) #text mining package
library(astsa) 
```

```{r, message=FALSE, warning=FALSE, include=FALSE}
#obtain data from eia.gov website. This dataset contains electricity generation
#monthly for the total U.S., categorized by source.

elec.raw <- read.csv(file = "https://www.eia.gov/totalenergy/data/browser/csv.php?tbl=T01.02",
                     stringsAsFactors=FALSE)


str(elec.raw) #look at structure of elec.raw dataframe
```

The data contains monthly totals from 1973-2017 by energy source, with units in quadrillions of British Thermal Untis. We convert the units to gigawatt-hours, more appropriate for electricity.

```{r, message=FALSE, warning=FALSE, include=FALSE}
#examine energy sources
(elec.sources <- unique(elec.raw$Description))

#remove unecessary words from sources
elec.raw$Description <- removeWords(elec.raw$Description,c(" Production", " Energy"))

```

```{r, message=FALSE, warning=FALSE, include=FALSE}
#look at the range of dates
range(elec.raw$YYYYMM)

#look at the range of values for generation
range(elec.raw$Value)
```

```{r, message=FALSE, warning=FALSE, include=FALSE}
#find indices containing "Not Available"
invisible(which(elec.raw$Value == "Not Available"))

#find which descriptions are in the indices containing "not available"
unique(elec.raw[which(elec.raw$Value == "Not Available"),5])
```

```{r, message=FALSE, include=FALSE}
#Format the data

qbtu.to.gigawatthours <- 293071.070172222215  # ratio of gigawatthours per quadrillion btus

#unique sources of energy (totals of groups removed):
sources <- unique(elec.raw$Description)[-c(5,12,13)]

#create dataframe for seperate energy sources
elec.sources <-   mutate(
  elec.raw, gwh = as.numeric(Value)*qbtu.to.gigawatthours,  #convert btus to gigawatthours
  YYYYMMDD = ymd(paste(YYYYMM, "01",sep = "")) #convert YYYYMM to date + first day of the month
  ) %>% 
  filter(Description %in% sources,  
    is.na(YYYYMMDD) == FALSE) %>%
  select(gwh,Description, YYYYMMDD)
```

Below is a plot of all the energy sources over time:

```{r, echo=FALSE, fig.height=4, fig.width=10, message=FALSE, warning=FALSE}
#plot generation sources over time
sourcesplot <- ggplot(data = elec.sources) + 
  geom_path(mapping = aes(x = elec.sources$YYYYMMDD,
                          y = elec.sources$gwh,
                          color = elec.sources$Description),
            na.rm = TRUE,
            size = .7) +
  ggtitle(label = "U.S. Electricity Generation 1973-2017 by Source") +
  xlab("Year") +
  ylab("Generation (gigawatt-hours)") +
  ggthemes::theme_tufte()

sourcesplot + labs(color = "Source")
```

We see that Solar energy is a small fraction of the total energy production. Despite this, it's experiencing exponential growth along with wind energy. We take a closer look below:

```{r, echo=FALSE, fig.height=4, fig.width=8, message=FALSE, warning=FALSE}

#create subset dataframe containing only wind and solar, from 1990+
elec.solarwind <- filter(elec.sources,
                         Description %in% c("Solar", "Wind"),
                         is.na(gwh) == FALSE,
                         YYYYMMDD >= as.Date("1990-01-01")
)
#plot generation sources over time
solarwindplot <- ggplot(data = elec.solarwind) + 
  geom_path(mapping = aes(x = elec.solarwind$YYYYMMDD,
                          y = elec.solarwind$gwh,
                          color = elec.solarwind$Description),
            na.rm = TRUE,
            size = .7) +
  ggtitle(label = "U.S. Solar and Wind Generation 1990-2017") +
  xlab("Year") +
  ylab("Generation (gigawatt-hours)") +
  ggthemes::theme_tufte()

solarwindplot + labs(color = "Source")
```

Both sources appear to have exponential growth, beginning about year 2000 for wind and 2010 for solar. Since solar begins its growth phase at about 2010, we will focus on that time frame to build a model.  
Since the growth is exponential, we will look at a log transformation of growth. Below is a plot of log transformed solar generation:  
  
```{r, echo=FALSE, message=FALSE, warning=FALSE}
elec.solar <- filter(elec.solarwind,
                     Description == "Solar",
                     YYYYMMDD >= as.Date("2010-01-01")
) %>%
  mutate(loggwh = log(gwh)
)

#plot generation sources over time

logsolarplot <- ggplot(data = elec.solar) + 
  geom_path(mapping = aes(x = elec.solar$YYYYMMDD,
                          y = elec.solar$loggwh,
                          color = Description),
            na.rm = TRUE,
            show.legend = FALSE,
            size = .7) +
  ggtitle(label = "U.S. Solar Generation (log transformed) 2010-2017") +
  xlab("Year") +
  ylab("Generation log(gigawatt-hours)") +
  ggthemes::theme_tufte()

logsolarplot + labs(color = "Source")

```

What we see here is a remarkably constant trend, with a consistent seasonal component. We will need to remove this trend to build an ARIMA model, because ARIMA models assume a stationary process (the mean and variance do not change over time). This can be done with differencing, subtracting the previous value from each observation. Below is a plot of the differenced series:

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#remove first row to match indices of differenced values
elec.diffsolar <- elec.solar[-1,]

#add differenced values
elec.diffsolar$diffsolar <- diff(elec.solar$loggwh)

difflogsolarplot <- ggplot(data = elec.diffsolar) + 
  geom_path(mapping = aes(x = elec.diffsolar$YYYYMMDD,
                          y = elec.diffsolar$diffsolar,
                          color = Description),
            na.rm = TRUE,
            show.legend = FALSE,
            size = .7) +
  ggtitle(label = "U.S. Solar Generation (differenced log transform) 2010-2017") +
  xlab("Year") +
  ylab("Generation log(gigawatt-hours)") +
  ggthemes::theme_tufte()

difflogsolarplot + labs(color = "Source")
```

The result appears to be a stationary series. We can begin fitting a model. Our first step in model building is to look at the auto-correlation and partial-auto-correlation plots of our dataset to get an idea of the model parameters we should use:  
  
  
```{r, echo=FALSE, message=FALSE, warning=FALSE}
#change graphical parameters to show less white space
invisible((acfpar <- par(mfrow = c(2,1), mar = c(2,4,1,2), xlab = NA)))
#acf plot
acf(elec.diffsolar$diffsolar, xlab = NA, main = NA, lag.max = 30)
#pacf plot
pacf(elec.diffsolar$diffsolar, main = NA, lag.max = 30)
```

